<meta charset="utf8" />
<html>
<script src='https://unpkg.com/sql.js@latest/dist/sql-wasm.js'></script>
<script defer>
  const config = {
    locateFile: filename => `https://unpkg.com/sql.js@latest/dist/${filename}`
  };

  initSqlJs(config).then(async function (SQL) {
    // æª¢æŸ¥ localStorage æ˜¯å¦å·²æœ‰è³‡æ–™åº«
    let db;
    // const savedDB = localStorage.getItem('myDatabase');
    let quota = 5 * 1024 * 1024 /*5MB*/
    await navigator.webkitPersistentStorage.requestQuota(quota)

    window.requestFileSystem = window.requestFileSystem || window.webkitRequestFileSystem;
    
    let filePath = 'database.sqlite';

    let readSavedDB = function () {
        return new Promise((resolve, reject) => {
          window.requestFileSystem(window.PERSISTENT, quota, (fs) => {
            fs.root.getFile(filePath, {}, (fileEntry) => {
              fileEntry.file((file) => {
                const reader = new FileReader();
                reader.onloadend = () => {
                  // å°‡è®€å–çš„ ArrayBuffer è½‰æ›ç‚º Uint8Array
                  console.log('ğŸ“‚ è®€å–æª”æ¡ˆæˆåŠŸ:', fileEntry.name);
                  resolve(new Uint8Array(reader.result));
                };
                reader.onerror = (error) => {
                  reject(error);
                };
                reader.readAsArrayBuffer(file);
              }, (error) => {
                reject(error);
              });
            }, (error) => {
              reject(error);
            });
          }, (error) => {
            reject(error);
          });
        });
    }

    await window.requestFileSystem(window.PERSISTENT, quota, async (fs) => {
      console.log('ğŸ“‚ å·²å–å¾—æª”æ¡ˆç³»çµ±å­˜å–æ¬Šé™');

      let savedDB
      try {
        savedDB = await readSavedDB();
      }
      catch (e) {
        console.error('âŒ ç„¡æ³•è®€å–è³‡æ–™åº«æª”æ¡ˆ:', e);
        console.log('ğŸ“‚ æ²’æœ‰æ‰¾åˆ°è³‡æ–™åº«æª”æ¡ˆï¼Œå°‡å»ºç«‹æ–°è³‡æ–™åº«');
      }

      console.log(savedDB)

      if (savedDB) {
        // å¦‚æœæœ‰ï¼Œå¾ localStorage è¼‰å…¥
        // const uInt8Array = Uint8Array.from(atob(savedDB), c => c.charCodeAt(0));
        // db = new SQL.Database(uInt8Array);
        db = new SQL.Database(savedDB);
        console.log('ğŸ“¦ å¾ localStorage è¼‰å…¥è³‡æ–™åº«');
        db.run("INSERT INTO test VALUES (?,?), (?,?)", [1, 111, 2, (new Date()).toISOString()]);
      } else {
        // æ²’æœ‰å°±æ–°å»ºä¸€å€‹
        db = new SQL.Database();
        db.run("CREATE TABLE IF NOT EXISTS test (col1, col2);");
        db.run("INSERT INTO test VALUES (?,?), (?,?)", [1, 111, 2, (new Date()).toISOString()]);
        console.log('âœ¨ å»ºç«‹æ–°è³‡æ–™åº«');
      }

      // æŸ¥è©¢è³‡æ–™
      const stmt = db.prepare("SELECT * FROM test WHERE col1 BETWEEN $start AND $end");
      stmt.bind({ $start: 1, $end: 2 });
      while (stmt.step()) {
        const row = stmt.getAsObject();
        console.log('ğŸ” æŸ¥è©¢çµæœ: ' + JSON.stringify(row));
      }
      stmt.free();

      // å„²å­˜è³‡æ–™åº«ç‹€æ…‹åˆ° localStorage
      const binaryArray = db.export();
      const base64String = btoa(String.fromCharCode.apply(null, binaryArray));
      
      // localStorage.setItem('myDatabase', base64String);
      fs.root.getFile(filePath, {
        create: true, exclusive: false
      }, (fileEntry) => {
        fileEntry.createWriter((fileWriter) => {
          // console.log(binaryArray)
          const blob = new Blob([binaryArray], { type: 'application/octet-stream' });
          fileWriter.write(blob);
          console.log('ğŸ“¦ è³‡æ–™åº«å·²å„²å­˜åˆ°æª”æ¡ˆç³»çµ±');
        }, (error) => {
          console.error('âŒ ç„¡æ³•å¯«å…¥æª”æ¡ˆ:', error);
        });
      }, (error) => {
        console.error('âŒ ç„¡æ³•å–å¾—æª”æ¡ˆ:', error);
      });

      console.log('ğŸ’¾ è³‡æ–™åº«å·²å„²å­˜åˆ° localStorage');

    }, (error) => {
      console.error('âŒ ç„¡æ³•å–å¾—æª”æ¡ˆç³»çµ±å­˜å–æ¬Šé™:', error);
    });

    
  });
</script>
<body>
  Output is in Javascript console
</body>
</html>
